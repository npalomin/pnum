---
title: "Manufacturing Places in London"
output:
  html_document:
    df_print: paged
---

*libraries*
```{r message=FALSE, warning=FALSE, paged.print=FALSE}
library(ggplot2)
library(ggthemes)
library(gridExtra)
library(knitr)
library(htmlTable)
library(readr)
library(sp)
library(rgeos)
library(tmap)
library(tmaptools)
library(sf)
library(rgdal)
library(geojsonio)
library(spData)
library(tidyverse)
library(maptools)
library(RColorBrewer)
```

##### Problem
Identify location outside the Industrial designated areas with high concentration of Manufacturing (jobs and businesses), economic activity and residences.

###### Manufacturing jobs
Data source: NOMIS official labour market statistics (ONS)
URL: https://www.nomisweb.co.uk/  
Definition: *"An employer survey of the number of jobs held by employees broken down by full/part-time and detailed industry (5 digit SIC2007). The survey records a job at the location of an employees workplace. Available from country down to lower level super output area and Scottish datazone."*  
Ref URLs: https://onsdigital.github.io/dp-classification-tools/standard-industrial-classification/ONS_SIC_hierarchy_view.html  

Read NOMIS data. Lower Layer Super Output Area (2011)  
Industry Standard industrial classification of economic activities (SIC) 2007 section C: Manufacturing
```{r message=FALSE, warning=FALSE}
nom <- read_csv("/Volumes/ritd-ag-project-rd00lq-jamfe87/GIS_Analysis/dataProcessed/nomis_4835.csv") # 4,835 obs.
```
Create variable 'lsoa11_cd' from variable 'lsoa11_2011' substract chr 1 to 4 (first 4 characters)
```{r, message=FALSE, warning=FALSE}
nom <- mutate(nom, lsoa11_cd = substr(lsoa_2011, 1, 9))
```

Summary of 'nom' Count and Industry percentage
```{r}
summary(nom)
```

```{r}
table(nom$Count) # 539 LSOA with 10 jobs in Manufacturing Industry
```
```{r}
nrow(table(nom$Count)) # [1] 34
dCount <-as.data.frame(table(nom$Count))
colnames(dCount) <-c("Jobs", "Frequency")
dCount1 <- cbind(dCount[1:10, ], dCount[11:20, ], dCount[21:30, ], dCount[31:40, ])
htmlTable(dCount1, rnames=F, caption="Jobs count frequency per LSOA (N = 4,835)", col.columns = c("none", "#F7F7F7"), css.cell="padding-left:1em; padding-right:1em;")
```


```{r}
table(nom[,3]) # 22 LSOA with 20% jobs in Manufacturing Industry
```

```{r}
nrow(table(nom$`Industry percentage`)) # [1] 107
dInd <-as.data.frame(table(nom$`Industry percentage`))
colnames(dInd) <-c("Perc.", "Frequency")
dInd1 <- cbind(dInd[1:22, ], dInd[23:44, ], dInd[45:66, ], dInd[67:88, ], dInd[89:110, ])
htmlTable(dInd1, rnames=F, caption="Jobs Percentage frequency per LSOA (N = 4,835)", col.columns = c("none", "#F7F7F7"), css.cell="padding-left:1em; padding-right:1em;")
```

Histograms
```{r}
# drop ) values
nom1 <- subset(nom, nom$Count > 0) # 1783
nom2 <- subset(nom, nom$`Industry percentage` > 0) # 1730

# style
th <- theme_tufte(base_family = "Georgia")

h1 <- ggplot(nom1, aes(Count)) + geom_histogram(bins = 6000/5, fill="magenta") + th + ylab("LSOAs") + xlab("Jobs")
h2 <- ggplot(nom1, aes(Count)) + geom_histogram(bins = 150/5, fill="magenta") + th + xlim(c(0, 150)) + ylab("LSOAs") + xlab("Jobs")
h3 <- ggplot(nom2, aes(`Industry percentage`)) + geom_histogram(bins = 100, fill="magenta") + th + ylab("LSOAs") + xlab("Ind. Percentage")
h4 <- ggplot(nom2, aes(`Industry percentage`)) + geom_histogram(bins = 200, fill="magenta") + th + xlim(c(0, 35)) + ylab("LSOAs") + xlab("Ind. Percentage")
grid.arrange(h1, h2, h3, h4, nrow=2)
```

Boxpolots
```{r}
fnC <- fivenum(nom1$Count)
fnP <- fivenum(nom2$`Industry percentage`)
anC <- annotate(geom="text", label=round(fnC ,digits=2), x= 1, y=fnC, size = 3, family = "Georgia", hjust =-.2)
anP <- annotate(geom="text", label=round(fnP ,digits=2), x= 1, y=fnP, size = 3, family = "Georgia", hjust =-.2)
th <- theme(axis.title=element_blank(),axis.ticks.x = element_blank(), axis.text.x=element_blank())

bC <- ggplot(nom1, aes(1, Count)) + geom_tufteboxplot() + scale_y_log10() + theme_classic() + anC +
  ggtitle("Jobs Count (N = 1,783)") + th + theme_tufte()
bP <- ggplot(nom2, aes(1, `Industry percentage`)) + geom_tufteboxplot() + scale_y_log10() + theme_classic() + anP  + ggtitle("Jobs Percentage (N = 1,730)") + th + theme_tufte()

grid.arrange(bC, bP, nrow=1)
```


Maps
```{r, message=FALSE, warning=FALSE}
lsoa <- st_read("/Volumes/ritd-ag-project-rd00lq-jamfe87/GIS_Analysis/dataRaw/statistical-gis-boundaries-london/ESRI/LSOA_2011_London_gen_MHW.shp")
```

Join with NOMIS data 'nom'
```{r}
mpl <- append_data(lsoa, nom, key.shp = "LSOA11CD", key.data = "lsoa11_cd", ignore.duplicates = TRUE, ignore.na = TRUE)
names(mpl)
```

Map of job counts > 35 & percentage > 6% (4th Q)
```{r}
colnames(mpl)[17] <- "IndPer"

c35 <- subset(mpl, Count >= 35)
p6 <- subset(mpl, IndPer >= 6)
CP <- subset(mpl, Count >= 35 | IndPer >= 6)
```


```{r}
mCP <- tm_shape(CP) +
    tm_polygons(c("Count",
                  "IndPer"), 
        style="jenks",
        palette="PuRd",
        title=c("Count",
                "Percentage"),
        border.col="white",
        border.alpha = 0.1) +
  tm_layout(inner.margins = c(0, 0.1, 0.05, 0.2), frame = F) +
  tm_legend(legend.position = c("right", "bottom"),
          main.title = "Jobs per LSOA",
          main.title.position = "right",
          main.title.size=0.9)
mCP
```



```{r}
colnames(mpl)[17] <- "IndPer"

c35 <- subset(mpl, Count >= 35)
p6 <- subset(mpl, IndPer >= 6)
```

```{r}
msum <- tm_shape(mpl) +
  tm_polygons(col="#ffffe5", border.col="#ededed", border.alpha = 0.01) + 
  tm_shape(c35) +
  tm_polygons("Count",
              style="jenks",
              palette="BuPu",
              title="Jobs Count",
              border.col="white",
              border.alpha = 0.1) + 
  tm_shape(p6) +
  tm_polygons(border.col = "magenta", border.alpha = 0.5, alpha = 0) +
  tm_layout(inner.margins = c(0, 0.1, 0.05, 0.2), frame = F) 
```

```{r}
tmap_mode("plot")
msum
```

